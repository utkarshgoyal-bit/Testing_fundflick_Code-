name: Deploy los-frontend

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Cache pnpm modules
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Setup Environment File
        run: |
          cat <<EOF > .env
          VITE_SERVER_BASE_URI="${{ secrets.VITE_SERVER_BASE_URI }}"
          VITE_COMPANY_NAME="${{ secrets.VITE_COMPANY_NAME }}"
          VITE_BANK_NAME="${{ secrets.VITE_BANK_NAME }}"
          VITE_ACCOUNT_NUMBER="${{ secrets.VITE_ACCOUNT_NUMBER }}"
          VITE_IFSC_CODE="${{ secrets.VITE_IFSC_CODE }}"
          VITE_API_KEY="${{ secrets.VITE_API_KEY }}"
          VITE_AUTH_DOMAIN="${{ secrets.VITE_AUTH_DOMAIN }}"
          VITE_PROJECT_ID="${{ secrets.VITE_PROJECT_ID }}"
          VITE_STORAGE_BUCKET="${{ secrets.VITE_STORAGE_BUCKET }}"
          VITE_MESSAGING_SENDER_ID="${{ secrets.VITE_MESSAGING_SENDER_ID }}"
          VITE_APP_ID="${{ secrets.VITE_APP_ID }}"
          VITE_MEASUREMENT_ID="${{ secrets.VITE_MEASUREMENT_ID }}"
          VITE_REACT_APP_FIREBASE_VAPID_KEY="${{ secrets.VITE_REACT_APP_FIREBASE_VAPID_KEY }}"
          VITE_FIREBASECONFIG='${{ secrets.VITE_FIREBASECONFIG }}'
          VITE_API_ENV=dev
          EOF

      - name: Show .env content (Debug only)
        run: cat .env

      - name: Install dependencies
        run: pnpm install

      - name: Build project
        run: pnpm run build

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Transfer built files to server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} 'rm -rf /root/dev/los-frontend/dist'
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -o StrictHostKeyChecking=no -r dist root@${{ secrets.SERVER_HOST }}:/root/dev/los-frontend/

      - name: SSH into server and restart frontend
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e
          cd /root/dev/los-frontend
          pm2 save
          if pm2 list | grep -q "dev-frontend"; then
            pm2 stop dev-frontend
            pm2 delete dev-frontend
          fi
          pm2 start "serve -s dist -l 5174" --name dev-frontend
          pm2 save
          pm2 startup
          echo "Deployment successful!"
          EOF
