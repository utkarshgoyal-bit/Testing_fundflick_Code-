#!/bin/sh

# Check if there are any staged files
staged_files=$(git diff --cached --name-only)
if [ -z "$staged_files" ]; then
    echo "âŒ Error: No files staged for commit. Please stage your changes first."
    echo "Use 'git add <files>' to stage files before committing."
    exit 1
fi

# Check if any staged files are source files that need linting
staged_source_files=$(git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' || true)
if [ -n "$staged_source_files" ]; then
    echo "ğŸ” Running ESLint on staged files..."
    
    # Run eslint on staged files - allow warnings but block on errors
    npx eslint $staged_source_files
    eslint_exit_code=$?
    
    if [ $eslint_exit_code -eq 2 ]; then
        echo "âŒ ESLint found errors in staged files. Please fix them before committing."
        echo "You can run 'npm run lint:fix' to auto-fix some issues."
        exit 1
    elif [ $eslint_exit_code -eq 1 ]; then
        echo "âš ï¸  ESLint found warnings in staged files, but commit will proceed."
        echo "Consider running 'npm run lint:fix' to fix warnings."
    fi
    
    echo "âœ… ESLint check passed!"
fi

# Run lint-staged for formatting and final checks
echo "ğŸ¨ Running lint-staged..."
npx lint-staged

if [ $? -ne 0 ]; then
    echo "âŒ lint-staged failed. Please fix the issues and try again."
    exit 1
fi

echo "âœ… All pre-commit checks passed!"